{

  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",

  "contentVersion": "1.0.0.0",

  "parameters": {

    "adminUsername": { "type": "string" },

    "adminPassword": { "type": "securestring" },

   

    "vmName" : { "type": "string" },

    "windowsOSVersion": {
      "type": "string",
      "defaultValue": "2016-Datacenter",
      "allowedValues": [
        
        "2012-R2-Datacenter",
        "2016-Datacenter"
      ]},
      "DataDiscCount": {
          "type": "int",
          "defaultValue": 2,
          "allowedValues": [
            
            2,
            4,
            6,
            8
          ]},

          "scriptFile": {
            "type": "string",
            "defaultValue": "https://raw.githubusercontent.com/sredlin/azure-arm-templates/master/Azure-New-Drive.ps1",
            "metadata": {
                  "description": "The script file location."
            }
        },
        "scriptName": {
          "type": "string",
          "defaultValue": "Azure-New-Drive.ps1",
          "metadata": {
                "description": "Name of the script file"
          }
      }

          
          

  },

  "variables": {

    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks', 'Azure-VNet-DC')]",

    

    "subnetRef": "[concat(variables('vnetID'),'/subnets/DC-Subnet')]" 

  },

  "resources": [

    {

      "apiVersion": "2016-03-30",

      "type": "Microsoft.Network/publicIPAddresses",

      "name": "[concat(parameters('vmName'),'-PublicIPAddress')]",

      "location": "[resourceGroup().location]",

      "properties": {

        "publicIPAllocationMethod": "Dynamic",

        "dnsSettings": {

          "domainNameLabel": "[tolower(concat(parameters('vmName'),'-PublicDNS-',uniqueString(resourceGroup().id)))]"

        }

      }

    },

    {

      "apiVersion": "2016-03-30",

      "type": "Microsoft.Network/virtualNetworks",

      "name": "Azure-VNet-DC",

      "location": "[resourceGroup().location]",

      "dependsOn": [
          "[concat('Microsoft.Network/networkSecurityGroups/', 'Allow-RDP')]"
      ],
      "properties": {

        "addressSpace": { "addressPrefixes": [ "10.0.0.0/16" ] },

        "subnets": [

          {

            "name": "DC-Subnet",

            "properties": { "addressPrefix": "10.0.0.0/24" },

            "networkSecurityGroup": {
              "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'Allow-RDP')]"
            }



          }

        ]

      }

    },

    {

      "apiVersion": "2016-03-30",

      "type": "Microsoft.Network/networkInterfaces",

      "name": "[concat(parameters('vmName'),'-NIC')]",

      "location": "[resourceGroup().location]",

      "dependsOn": [

        "[resourceId('Microsoft.Network/publicIPAddresses/', concat(parameters('vmName'),'-PublicIPAddress'))]",

        "[resourceId('Microsoft.Network/virtualNetworks/', 'Azure-VNet-DC')]"

      ],

      "properties": {

        "ipConfigurations": [

          {

            "name": "[concat(parameters('vmName'),'-IPConfig')]",

            "properties": {

              "privateIPAllocationMethod": "Dynamic",

              "publicIPAddress": { "id": "[resourceId('Microsoft.Network/publicIPAddresses',concat(parameters('vmName'),'-PublicIPAddress'))]" },

              "subnet": { "id": "[variables('subnetRef')]" }

            }

          }

        ]

      }

    },

    {

      "apiVersion": "2016-04-30-preview",

      "type": "Microsoft.Compute/virtualMachines",

      "name": "[parameters('vmName')]",

      "location": "[resourceGroup().location]",

      "dependsOn": [

        "[resourceId('Microsoft.Network/networkInterfaces/', concat(parameters('vmName'),'-NIC'))]"

      ],

      "properties": {

        "hardwareProfile": { "vmSize": "Standard_D2" },

        "osProfile": {

          "computerName": "[parameters('vmName')]",

          "adminUsername": "[parameters('adminUsername')]",

          "adminPassword": "[parameters('adminPassword')]"

        },

        "storageProfile": {

          "imageReference": {

            "publisher": "MicrosoftWindowsServer",

            "offer": "WindowsServer",

            "sku": "[parameters('windowsOSVersion')]",

            "version": "latest"

          },

          "osDisk": {

            "name": "[concat(parameters('vmName'),'-OSDisk')]",

            "caching": "ReadWrite",

            "createOption": "FromImage"

          },
          "copy": [

              {
  
                "name": "dataDisks",
  
                "count": "[parameters('DataDiscCount')]",
  
                "input": {

                  "name": "[concat(parameters('vmName'),'-dataDisk-',copyIndex('dataDisks'))]",
  
                  "diskSizeGB": 5,
  
                  "lun": "[copyIndex('dataDisks')]",
  
                  "createOption": "Empty"
  
                }
  
              }
  
            ]
        },

        "networkProfile": {

          "networkInterfaces": [

            {

              "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('vmName'),'-NIC'))]"

            }

          ]

        },

        


         "resources": [
              {
                  "type": "Microsoft.Compute/virtualMachines/extensions",
                  "name": "[concat(parameters('vmName'),'/CustomScriptExtension')]",
                  "apiVersion": "2015-05-01-preview",
                  "location": "[resourceGroup().location]",
                  "dependsOn": [
                      "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'))]"
                  ],
                  "properties": {
       	           "publisher": "Microsoft.Compute",
       	           "type": "CustomScriptExtension",
                     "typeHandlerVersion": "1.7",
                     "autoUpgradeMinorVersion":true,
                     "settings": {
                         "fileUris": [ "[parameters('scriptFile')]" ],
       	                  "commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -file ', parameters('scriptName'))]"
                     }
                 }
              }
            ]







      }

    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "Allow-RDP",
      "location": "[resourceGroup().location]",
      "properties": {
        "securityRules": [
          {
              "name": "Allow-RDP",
              "properties": {
                "description": "Allow-RDP",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "Internet",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 101,
                "direction": "Inbound"
            }
          }
        ]
      }
    }
    

  ]

}