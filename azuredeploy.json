{

  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",

  "contentVersion": "1.0.0.0",

  "parameters": {

    "adminUsername": { "type": "string",
      "defaultValue": "Adminvsc"
    },

    "adminPassword": { "type": "securestring" },

   

    "vmName" : { "type": "string" },

    "windowsOSVersion": {
      "type": "string",
      "defaultValue": "2016-Datacenter",
      "allowedValues": [
        
        "2012-R2-Datacenter",
        "2016-Datacenter"
      ]},
      "DataDiscCount": {
          "type": "int",
          "defaultValue": 2,
          "allowedValues": [
            
            2,
            4,
            6,
            8
          ]},

          "DeplyomentType": {
            "type": "string",
            "defaultValue": "DC",
            "allowedValues": [
              
              "DC",
              "SQL",
              "Frontend"
              
            ]},
            "numberOfInstances": {
              "type": "int",
              "defaultValue": 2,
              "minValue": 2,
              "maxValue": 5}
              
            

  },

  "variables": {

    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks', concat('Azure-Vnet-',parameters('DeplyomentType')))]",

    

    "subnetRef": "[concat(variables('vnetID'),'/subnets/', parameters('DeplyomentType'), '-Subnet')]" 

  },

  "resources": [

    {
      "type": "Microsoft.Compute/availabilitySets",
      "name": "[concat('HA-',parameters('DeplyomentType'))]",
      "apiVersion": "[providers('Microsoft.Compute', 'availabilitySets').apiVersions[0]]",
	"location": "[resourceGroup().location]",
	"properties": {
	    "platformFaultDomainCount": 2,
	    "platformUpdateDomainCount": 3
	    
  },
  
  "sku": {
    "name": "Aligned"
  }
    },


    {

      "apiVersion": "2016-03-30",

      "type": "Microsoft.Network/publicIPAddresses",

      "name": "[concat(parameters('vmName'),copyindex(),'-PublicIPAddress')]",

      "location": "[resourceGroup().location]",
      "copy": {
        
        "name": "publicipaddressloop",
        "count": "[parameters('numberOfInstances')]"
        
              },

      "properties": {

        "publicIPAllocationMethod": "Dynamic",

        "dnsSettings": {

          "domainNameLabel": "[tolower(concat(parameters('vmName'),copyindex(),'-PublicDNS-',uniqueString(resourceGroup().id)))]"

        }

      }

    },

    {

      "apiVersion": "2016-03-30",

      "type": "Microsoft.Network/virtualNetworks",

      "name": "[concat('Azure-VNet-',parameters('DeplyomentType'))]",

      "location": "[resourceGroup().location]",

    
      "properties": {

        "addressSpace": { "addressPrefixes": [ "10.0.0.0/16" ]},

        "subnets": [

          {

            "name": "[concat(parameters('DeplyomentType'), '-Subnet')]",

            "properties": { "addressPrefix": "10.0.0.0/24"           
            
            }





          }
        ]

      }

    },

    {

      "apiVersion": "2016-03-30",

      "type": "Microsoft.Network/networkInterfaces",

      "name": "[concat(parameters('vmName'),copyindex(),'-NIC')]",

      "location": "[resourceGroup().location]",

      "copy": {
        
"name": "nicloop",
"count": "[parameters('numberOfInstances')]"

      },

      "dependsOn": [

        "[resourceId('Microsoft.Network/publicIPAddresses/', concat(parameters('vmName'),copyindex(),'-PublicIPAddress'))]",

        "[resourceId('Microsoft.Network/virtualNetworks/', concat('Azure-VNet-',parameters('DeplyomentType')))]",


      
        "[concat('Microsoft.Network/networkSecurityGroups/', 'Allow-RDP')]"
      

      ],

      "properties": {
        "dnsSettings":{
          "dnsServers":["10.0.0.5"]
      },
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'Allow-RDP')]"
        },

        "ipConfigurations": [

          {

            "name": "[concat(parameters('vmName'),copyindex(),'-IPConfig')]",

            "properties": {
              

              "privateIPAllocationMethod": "Dynamic",

              "publicIPAddress": { "id": "[resourceId('Microsoft.Network/publicIPAddresses',concat(parameters('vmName'),copyindex(),'-PublicIPAddress'))]" },

              "subnet": { "id": "[variables('subnetRef')]" }

            }

          }

        ]

      }

    },

    {

      "apiVersion": "2016-04-30-preview",

      "type": "Microsoft.Compute/virtualMachines",

      "name": "[concat(parameters('vmName'),copyindex())]",

      "location": "[resourceGroup().location]",
"copy": {
  
  "name": "vmloop",
  "count": "[parameters('numberOfInstances')]"
  
        },
      

      "dependsOn": [

        "[resourceId('Microsoft.Network/networkInterfaces/', concat(parameters('vmName'),copyindex(),'-NIC'))]"

      ],

      "properties": {

        "availabilitySet": {
          "id": "[resourceId('Microsoft.Compute/availabilitySets', concat('HA-', parameters('DeplyomentType')))]"
        },

        "hardwareProfile": { "vmSize": "Standard_D2"},

        "osProfile": {

          "computerName": "[concat(parameters('vmName'),copyindex())]",

          "adminUsername": "[parameters('adminUsername')]",

          "adminPassword": "[parameters('adminPassword')]"

        },

        "storageProfile": {

          "imageReference": {

            "publisher": "MicrosoftWindowsServer",

            "offer": "WindowsServer",

            "sku": "[parameters('windowsOSVersion')]",

            "version": "latest"

          },

          "osDisk": {

            "name": "[concat(parameters('vmName'),copyindex(),'-OSDisk')]",

            "caching": "ReadWrite",

            "createOption": "FromImage"

          },
          "copy": [

              {
  
                "name": "dataDisks",
  
                "count": "[parameters('DataDiscCount')]",
  
                "input": {

                  "name": "[concat(parameters('vmName'),copyindex(),'-dataDisk-',copyIndex('dataDisks'))]",
  
                  "diskSizeGB": 5,
  
                  "lun": "[copyIndex('dataDisks')]",
  
                  "createOption": "Empty"
  
                }
  
              }
  
            ]

        },

        "networkProfile": {

          "networkInterfaces": [

            {

              "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('vmName'),copyindex(),'-NIC'))]"

            }

          ]
        

        }







      }

    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "Allow-RDP",
      "location": "[resourceGroup().location]",
      "properties": {
        "securityRules": [
          {
              "name": "Allow-RDP",
              "properties": {
                "description": "Allow-RDP",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "Internet",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 101,
                "direction": "Inbound"
            }
          }
        ]
      }
    }
    

  ]

}